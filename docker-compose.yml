version: '3.8'

# Production-ready Headscale deployment with nginx reverse proxy
#
# This configuration is optimized for production use with SSL/TLS support.
# For local development, create docker-compose.override.yml from
# docker-compose.override.example.yml
#
# Quick start:
# 1. Copy .env.example to .env and configure
# 2. Update HEADSCALE_DOMAIN in .env
# 3. For production: docker compose up -d
# 4. For development: cp docker-compose.override.example.yml docker-compose.override.yml
#                     then docker compose up -d

services:
  headscale:
    image: headscale/headscale:v0.27.0
    container_name: headscale
    restart: unless-stopped
    command: serve
    environment:
      - TZ=${TZ:-UTC}
    volumes:
      - ./config:/etc/headscale
      - ./data:/var/lib/headscale
    networks:
      - headscale-network
    # Metrics endpoint - localhost only for security
    ports:
      - 127.0.0.1:9090:9090
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [CMD, headscale, health]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    # Production ports (80 for HTTP->HTTPS redirect, 443 for HTTPS)
    ports:
      - 80:80
      - 443:443
    volumes:
      # Production config with SSL/TLS support
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
      # SSL certificates from certbot
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    networks:
      - headscale-network
    depends_on:
      headscale:
        condition: service_healthy
    healthcheck:
      test: [CMD, wget, --quiet, --tries=1, --spider, http://localhost:8080/health]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    environment:
      - HEADSCALE_DOMAIN=${HEADSCALE_DOMAIN:-headscale.example.com}

  headplane:
    image: ghcr.io/tale/headplane:latest
    container_name: headplane
    restart: unless-stopped
    # Headplane UI exposed directly (can also access via nginx at /admin)
    ports:
      - 3001:3000
    volumes:
      - ./headplane:/etc/headplane
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - headscale-network
    depends_on:
      - headscale
    environment:
      - TZ=${TZ:-UTC}
      - HEADPLANE_API_KEY=${HEADPLANE_API_KEY}
      - HEADPLANE_COOKIE_SECRET=${HEADPLANE_COOKIE_SECRET}
    healthcheck:
      test: [CMD, wget, --quiet, --tries=1, --spider, http://localhost:3000/health]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  postgres:
    image: postgres:18-alpine
    container_name: headscale-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-headscale}
      POSTGRES_USER: ${POSTGRES_USER:-headscale}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - headscale-network
    healthcheck:
      test: [CMD-SHELL, "pg_isready -U $${POSTGRES_USER:-headscale}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Certbot for automated SSL/TLS certificate management
  # Obtains and renews Let's Encrypt certificates
  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # Auto-renew certificates every 12 hours
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --quiet; sleep 12h & wait $${!}; done;'"
    depends_on:
      - nginx

networks:
  headscale-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
